
-- to convert sample time from DB OS time zone to browser time zone

-- first determine OS DB Time Zone:
SELECT TO_CHAR(SYSTIMESTAMP, 'tzr') FROM dual
	'+00:00'
		-- this is always HR:MI format, not TZ name format

-- then convert. Browser TZ has to be supplied in browser request
select trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') as sample_time_browser_tz, 
a.* from v$active_session_history a;

-- available wait classes
select distinct wait_class from v$event_name order by 1;
	-- 13 wait classes including Idle :
			Administrative
			Application
			Cluster
			Commit
			Concurrency
			Configuration
			Idle
			Network
			Other
			Queueing
			Scheduler
			System I/O
			User I/O
	-- ON CPU is not included, as it is not wait
	-- in v$active_session_history wait class is shown in WAIT_CLASS
	-- "ON CPU" is shown in SESSION_STATE

-- available events per wait class
select wait_class, count(1) from v$event_name
group by wait_class;
	-- too numerous to hard code ...
	-- too numerous to pivot in sql ...
			Administrative	57
			Application		17
			Cluster			68
			Commit			4
			Concurrency		49
			Configuration	27
			Idle			135
			Network			29
			Other			1314
			Queueing		9
			Scheduler		10
			System I/O		35
			User I/O		57

			
-- Active Sessions Counts from v$active_session_history
-- Non-Pivot
-- sample_time is converted to browser tz
-- in 12c the table has sample_time_utc, but pre-12c do not have it, so i will stick with sample_time

	select count(distinct session_id||'-'||session_serial#) as active_sessions,
        trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') as sample_time_browser_tz, 
    	case when session_state = 'ON CPU' then 'ON CPU'
    	else wait_class	end as activity_class
    from v$active_session_history where wait_class <> 'Idle'
    group by
        trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI'), 
    	case when session_state = 'ON CPU' then 'ON CPU'
    	else wait_class end
    order by 2 desc,3
	
		ACTIVE_SESSIONS, SAMPLE_TIME_BROWSER_TZ, ACTIVITY_CLASS
					1	06-FEB-19 04:24:00	System I/O
					1	06-FEB-19 04:19:00	System I/O
					1	06-FEB-19 04:14:00	Other
					3	06-FEB-19 04:14:00	System I/O
					1	06-FEB-19 04:12:00	System I/O
					1	06-FEB-19 04:09:00	System I/O
					...

--
-- Pivot of above sql
--
	with pivot_data AS (
		select count(distinct session_id||'-'||session_serial#) as active_sessions,
			trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') as sample_time_browser_tz, 
			case when session_state = 'ON CPU' then 'ON CPU'
			else wait_class	end as activity_class
		from v$active_session_history where wait_class <> 'Idle'
		group by
			trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI'), 
			case when session_state = 'ON CPU' then 'ON CPU'
			else wait_class end 
		)
	--
	select 	sample_time_browser_tz, 
			administrative,
			application,
			clustr,
			commit,
			concurrency,
			configuration,
			idle,
			network,
			other,
			queueing,
			scheduler,
			system_io,
			user_io
	from pivot_data
	pivot
	( sum(active_sessions)
	for activity_class
		in ('Administrative' as administrative,
			'Application'	 as application,
			'Cluster'		 as clustr,
			'Commit'		 as commit,
			'Concurrency'	 as concurrency,
			'Configuration'	 as configuration,
			'Idle'			 as idle,
			'Network'		 as network,
			'Other'			 as other,
			'Queueing'		 as queueing,
			'Scheduler'		 as scheduler,
			'System I/O'	 as system_io,
			'User I/O'		 as user_io)
	)
	order by sample_time_browser_tz desc


--
-- Active Sessions Counts from DBA_HIST_ACTIVE_SESS_HISTORY
-- SAMPLE_TIME is aggregated in 5min intervals
-- SAMPLE_TIME is converted to browser tz
-- in 12c the table has SAMPLE_TIME_UTC, but pre-12c do not have it, so i will stick with SAMPLE_TIME
-- WAIT_CLASS is renamed "activity_class" by excluding "Idle" and taking "ON CPU" from SESSION_STATE
--
	select 
		count(distinct session_id||'-'||session_serial#) as active_sessions,
		trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') 
			- mod(extract(minute from from_tz(sample_time,'+00:00') at time zone 'America/New_York'), 5) 
			as sample_time_browser_tz_5min, 
		case when session_state = 'ON CPU' then 'ON CPU'
		else wait_class	end as activity_class
	from DBA_HIST_ACTIVE_SESS_HISTORY where wait_class <> 'Idle'
	group by
		trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') 
			- mod(extract(minute from from_tz(sample_time,'+00:00') at time zone 'America/New_York'), 5), 
		case when session_state = 'ON CPU' then 'ON CPU'
		else wait_class end
	order by 2 desc,3;

	ACTIVE_SESSIONS, SAMPLE_TIME_BROWSER_TZ_5MIN, ACTIVITY_CLASS
					1	06-FEB-19 03:30:00	System I/O
					1	06-FEB-19 01:35:00	System I/O
					1	06-FEB-19 12:20:00	Other
					1	06-FEB-19 12:05:00	System I/O
					1	06-FEB-19 11:30:00	System I/O
					1	06-FEB-19 10:50:00	Other

--
-- Pivot of above sql
--
	with pivot_data AS (
		select 
			count(distinct session_id||'-'||session_serial#) as active_sessions,
			trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') 
				- mod(extract(minute from from_tz(sample_time,'+00:00') at time zone 'America/New_York'), 5) 
				as sample_time_browser_tz_5min, 
			case when session_state = 'ON CPU' then 'ON CPU'
			else wait_class	end as activity_class
		from DBA_HIST_ACTIVE_SESS_HISTORY where wait_class <> 'Idle'
		group by
			trunc( from_tz(sample_time,'+00:00') at time zone 'America/New_York','MI') 
				- mod(extract(minute from from_tz(sample_time,'+00:00') at time zone 'America/New_York'), 5), 
			case when session_state = 'ON CPU' then 'ON CPU'
			else wait_class end
			)
	--
	select 	sample_time_browser_tz_5min, 
			administrative,
			application,
			clustr,
			commit,
			concurrency,
			configuration,
			idle,
			network,
			other,
			queueing,
			scheduler,
			system_io,
			user_io
	from pivot_data
	pivot
	( sum(active_sessions)
	for activity_class
		in ('Administrative' as administrative,
			'Application'	 as application,
			'Cluster'		 as clustr,
			'Commit'		 as commit,
			'Concurrency'	 as concurrency,
			'Configuration'	 as configuration,
			'Idle'			 as idle,
			'Network'		 as network,
			'Other'			 as other,
			'Queueing'		 as queueing,
			'Scheduler'		 as scheduler,
			'System I/O'	 as system_io,
			'User I/O'		 as user_io)
	)
	order by sample_time_browser_tz_5min desc
